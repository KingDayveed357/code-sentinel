"use client"

import { memo, useState, useEffect, useMemo } from "react"
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Legend } from "recharts"
import { useTheme } from "next-themes"


export const VulnerabilityTrendChart = memo(function VulnerabilityTrendChart() {
  const { theme, systemTheme } = useTheme()
  const [mounted, setMounted] = useState(false)

  useEffect(() => {
    setMounted(true)
  }, [])

  // Memoized chart data to prevent recalculations
  const chartData = useMemo(() => [
    { month: "Jan", critical: 8, high: 15, medium: 32, low: 20 },
    { month: "Feb", critical: 6, high: 12, medium: 28, low: 18 },
    { month: "Mar", critical: 7, high: 14, medium: 25, low: 16 },
    { month: "Apr", critical: 5, high: 10, medium: 22, low: 14 },
    { month: "May", critical: 4, high: 9, medium: 20, low: 13 },
    { month: "Jun", critical: 3, high: 8, medium: 21, low: 15 },
  ], [])

  const currentTheme = theme === "system" ? systemTheme : theme
  const isDark = currentTheme === "dark"

  // Premium color palette
  const colors = useMemo(() => ({
    text: isDark ? "#e2e8f0" : "#1e293b",
    grid: isDark ? "#334155" : "#e2e8f0",
    tooltipBg: isDark ? "#1e293b" : "#ffffff",
    tooltipBorder: isDark ? "#475569" : "#cbd5e1",
    critical: { line: "#dc2626", gradient: isDark ? "#dc262620" : "#dc262610" },
    high: { line: "#ea580c", gradient: isDark ? "#ea580c20" : "#ea580c10" },
    medium: { line: "#eab308", gradient: isDark ? "#eab30820" : "#eab30810" },
    low: { line: "#22c55e", gradient: isDark ? "#22c55e20" : "#22c55e10" },
  }), [isDark])

  if (!mounted) {
    return (
      <Card className="overflow-hidden">
        <CardHeader>
          <CardTitle>Vulnerability Trends</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="h-[320px] bg-muted/20 rounded-lg animate-pulse shimmer" />
        </CardContent>
      </Card>
    )
  }

  return (
    <Card className="overflow-hidden hover:shadow-lg transition-all duration-300 animate-in fade-in-50 slide-in-from-bottom-4" style={{ animationDelay: '300ms' }}>
      <CardHeader className="border-b border-border/50">
        <div className="flex items-center justify-between">
          <CardTitle>Vulnerability Trends</CardTitle>
          <div className="flex items-center gap-2 text-xs text-muted-foreground">
            <div className="h-2 w-2 rounded-full bg-green-500 animate-pulse" />
            <span>Last 6 months</span>
          </div>
        </div>
      </CardHeader>
      <CardContent className="pt-6">
        <div className="h-[320px]">
          <ResponsiveContainer width="100%" height="100%">
            <LineChart 
              data={chartData}
              margin={{ top: 5, right: 10, left: -20, bottom: 5 }}
            >
              <defs>
                {/* Gradient definitions for premium look */}
                <linearGradient id="criticalGradient" x1="0" y1="0" x2="0" y2="1">
                  <stop offset="5%" stopColor={colors.critical.line} stopOpacity={0.3}/>
                  <stop offset="95%" stopColor={colors.critical.line} stopOpacity={0}/>
                </linearGradient>
                <linearGradient id="highGradient" x1="0" y1="0" x2="0" y2="1">
                  <stop offset="5%" stopColor={colors.high.line} stopOpacity={0.3}/>
                  <stop offset="95%" stopColor={colors.high.line} stopOpacity={0}/>
                </linearGradient>
                <linearGradient id="mediumGradient" x1="0" y1="0" x2="0" y2="1">
                  <stop offset="5%" stopColor={colors.medium.line} stopOpacity={0.3}/>
                  <stop offset="95%" stopColor={colors.medium.line} stopOpacity={0}/>
                </linearGradient>
                <linearGradient id="lowGradient" x1="0" y1="0" x2="0" y2="1">
                  <stop offset="5%" stopColor={colors.low.line} stopOpacity={0.3}/>
                  <stop offset="95%" stopColor={colors.low.line} stopOpacity={0}/>
                </linearGradient>
              </defs>
              
              <CartesianGrid 
                strokeDasharray="3 3" 
                stroke={colors.grid} 
                strokeOpacity={0.3}
                vertical={false}
              />
              
              <XAxis 
                dataKey="month" 
                stroke={colors.text} 
                style={{ fontSize: "0.75rem", fontWeight: 500 }}
                tickLine={false}
                axisLine={false}
                dy={10}
              />
              
              <YAxis 
                stroke={colors.text} 
                style={{ fontSize: "0.75rem", fontWeight: 500 }}
                tickLine={false}
                axisLine={false}
                dx={-10}
              />
              
              <Tooltip 
                content={<CustomTooltip colors={colors} />}
                cursor={{ stroke: colors.grid, strokeWidth: 1, strokeDasharray: "5 5" }}
              />
              
              <Legend 
                wrapperStyle={{ 
                  paddingTop: "20px",
                  fontSize: "0.813rem",
                  fontWeight: 500
                }}
                iconType="circle"
                iconSize={8}
              />
              
              <Line
                type="monotone"
                dataKey="critical"
                stroke={colors.critical.line}
                strokeWidth={2.5}
                dot={{ fill: colors.critical.line, r: 4, strokeWidth: 2, stroke: "#fff" }}
                activeDot={{ r: 6, strokeWidth: 2, stroke: "#fff" }}
                name="Critical"
                animationDuration={1000}
                animationEasing="ease-out"
              />
              
              <Line
                type="monotone"
                dataKey="high"
                stroke={colors.high.line}
                strokeWidth={2.5}
                dot={{ fill: colors.high.line, r: 4, strokeWidth: 2, stroke: "#fff" }}
                activeDot={{ r: 6, strokeWidth: 2, stroke: "#fff" }}
                name="High"
                animationDuration={1000}
                animationEasing="ease-out"
              />
              
              <Line
                type="monotone"
                dataKey="medium"
                stroke={colors.medium.line}
                strokeWidth={2.5}
                dot={{ fill: colors.medium.line, r: 4, strokeWidth: 2, stroke: "#fff" }}
                activeDot={{ r: 6, strokeWidth: 2, stroke: "#fff" }}
                name="Medium"
                animationDuration={1000}
                animationEasing="ease-out"
              />
              
              <Line
                type="monotone"
                dataKey="low"
                stroke={colors.low.line}
                strokeWidth={2.5}
                dot={{ fill: colors.low.line, r: 4, strokeWidth: 2, stroke: "#fff" }}
                activeDot={{ r: 6, strokeWidth: 2, stroke: "#fff" }}
                name="Low"
                animationDuration={1000}
                animationEasing="ease-out"
              />
            </LineChart>
          </ResponsiveContainer>
        </div>
      </CardContent>
    </Card>
  )
})


const CustomTooltip = memo(function CustomTooltip({ active, payload, label, colors }: any) {
  if (!active || !payload || !payload.length) return null

  return (
    <div 
      className="rounded-lg border shadow-lg p-3 backdrop-blur-sm animate-in fade-in-50 zoom-in-95 duration-150"
      style={{
        backgroundColor: colors.tooltipBg,
        borderColor: colors.tooltipBorder,
      }}
    >
      <p className="font-semibold mb-2 text-sm" style={{ color: colors.text }}>
        {label}
      </p>
      <div className="space-y-1">
        {payload.map((entry: any, index: number) => (
          <div key={index} className="flex items-center justify-between gap-4 text-xs">
            <div className="flex items-center gap-2">
              <div 
                className="h-2 w-2 rounded-full" 
                style={{ backgroundColor: entry.color }}
              />
              <span style={{ color: colors.text }}>{entry.name}</span>
            </div>
            <span className="font-semibold tabular-nums" style={{ color: entry.color }}>
              {entry.value}
            </span>
          </div>
        ))}
      </div>
    </div>
  )
})

