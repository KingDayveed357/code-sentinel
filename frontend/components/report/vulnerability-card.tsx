// components/report/vulnerability-card.tsx - With DB persistence
"use client";

import { useState, useEffect } from "react";
import { Card } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Separator } from "@/components/ui/separator";
import {
  Collapsible,
  CollapsibleContent,
  CollapsibleTrigger,
} from "@/components/ui/collapsible";
import {
  ChevronDown,
  ChevronRight,
  AlertCircle,
  AlertTriangle,
  Info,
  CheckCircle2,
  ExternalLink,
  Github,
  Loader2,
} from "lucide-react";
import Link from "next/link";
import { useToast } from "@/hooks/use-toast";
import { githubIssuesApi } from "@/lib/api/github-issue";

export interface VulnerabilityData {
  id: string;
  severity: "critical" | "high" | "medium" | "low" | "info";
  title: string;
  file: string;
  line: number | null;
  description: string;
  remediation?: string;
  cwe?: string;
  code_snippet?: string;
  source: "sast" | "sca" | "secrets" | "iac" | "container";
  github_issue_url?: string;
  github_issue_number?: number;
}

interface VulnerabilityCardProps {
  vulnerability: VulnerabilityData;
  projectId: string;
  scanId: string;
  defaultExpanded?: boolean;
}

const severityConfig = {
  critical: {
    icon: AlertCircle,
    className: "border-l-red-500 hover:bg-red-50/50 dark:hover:bg-red-950/10",
    badgeClass: "bg-red-100 text-red-800 dark:bg-red-950 dark:text-red-400 border-red-200",
    label: "Critical",
  },
  high: {
    icon: AlertTriangle,
    className: "border-l-orange-500 hover:bg-orange-50/50 dark:hover:bg-orange-950/10",
    badgeClass: "bg-orange-100 text-orange-800 dark:bg-orange-950 dark:text-orange-400 border-orange-200",
    label: "High",
  },
  medium: {
    icon: AlertTriangle,
    className: "border-l-yellow-500 hover:bg-yellow-50/50 dark:hover:bg-yellow-950/10",
    badgeClass: "bg-yellow-100 text-yellow-800 dark:bg-yellow-950 dark:text-yellow-400 border-yellow-200",
    label: "Medium",
  },
  low: {
    icon: Info,
    className: "border-l-blue-500 hover:bg-blue-50/50 dark:hover:bg-blue-950/10",
    badgeClass: "bg-blue-100 text-blue-800 dark:bg-blue-950 dark:text-blue-400 border-blue-200",
    label: "Low",
  },
  info: {
    icon: Info,
    className: "border-l-gray-500 hover:bg-gray-50/50 dark:hover:bg-gray-900/10",
    badgeClass: "bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-400 border-gray-200",
    label: "Info",
  },
};

export function VulnerabilityCard({
  vulnerability,
  projectId,
  scanId,
  defaultExpanded = false,
}: VulnerabilityCardProps) {
  const { toast } = useToast();
  const [isExpanded, setIsExpanded] = useState(defaultExpanded);
  const [creatingIssue, setCreatingIssue] = useState(false);
  const [loadingIssue, setLoadingIssue] = useState(false);
  const [issueUrl, setIssueUrl] = useState<string | undefined>(vulnerability.github_issue_url);
  const [issueNumber, setIssueNumber] = useState<number | undefined>(vulnerability.github_issue_number);

  const config = severityConfig[vulnerability.severity];
  const SeverityIcon = config.icon;

  // Load existing issue from database on mount
  useEffect(() => {
    loadExistingIssue();
  }, [vulnerability.id, vulnerability.source]);

  async function loadExistingIssue() {
    // Skip if we already have issue info from props
    if (vulnerability.github_issue_url) {
      setIssueUrl(vulnerability.github_issue_url);
      setIssueNumber(vulnerability.github_issue_number);
      return;
    }

    try {
      setLoadingIssue(true);
      
      // Fetch issues for this scan
      const { issues } = await githubIssuesApi.getIssuesForScan(scanId);
      
      // Find issue for this vulnerability
      const existingIssue = issues.find(
        (issue) => 
          issue.vulnerability_id === vulnerability.id && 
          issue.vulnerability_type === vulnerability.source &&
          issue.issue_status === 'open'
      );

      if (existingIssue) {
        setIssueUrl(existingIssue.github_issue_url);
        setIssueNumber(existingIssue.github_issue_number);
      }
    } catch (err) {
      // Silently fail - issue might not exist yet
      console.debug('No existing issue found for vulnerability:', vulnerability.id);
    } finally {
      setLoadingIssue(false);
    }
  }

  async function handleCreateIssue() {
    try {
      setCreatingIssue(true);

      const result = await githubIssuesApi.createIssue(
        vulnerability.id,
        vulnerability.source
      );

      if (result.success && result.issue_url && result.issue_number) {
        setIssueUrl(result.issue_url);
        setIssueNumber(result.issue_number);

        toast({
          title: "GitHub Issue Created",
          description: `Issue #${result.issue_number} created successfully.`,
        });
      } else {
        throw new Error(result.error || result.message || "Failed to create issue");
      }
    } catch (err: any) {
      console.error("Error creating GitHub issue:", err);
      toast({
        title: "Failed to Create Issue",
        description: err.message || "Unable to create GitHub issue. Please try again.",
        variant: "destructive",
      });
    } finally {
      setCreatingIssue(false);
    }
  }

  return (
    <Card className={`border-l-4 transition-all duration-200 ${config.className}`}>
      <Collapsible open={isExpanded} onOpenChange={setIsExpanded}>
        <CollapsibleTrigger className="w-full">
          <div className="flex items-start gap-2 sm:gap-3 p-3 sm:p-4">
            <SeverityIcon className="h-4 w-4 sm:h-5 sm:w-5 mt-0.5 shrink-0 hidden xs:block" />

            <div className="flex-1 text-left min-w-0">
              <div className="flex items-start gap-2 mb-2">
                <h4 className="font-semibold text-sm sm:text-base break-words flex-1 leading-snug">
                  {vulnerability.title}
                </h4>

                <Badge className={`${config.badgeClass} shrink-0 text-[10px] sm:text-xs px-1.5 sm:px-2 py-0.5`}>
                  {config.label}
                </Badge>
              </div>

              <div className="flex flex-col gap-1.5 sm:gap-2">
                <code className="bg-muted px-2 py-1 rounded text-[10px] sm:text-xs font-mono break-all inline-block max-w-full">
                  {vulnerability.file}
                  {vulnerability.line && `:${vulnerability.line}`}
                </code>

                <div className="flex items-center gap-1.5 sm:gap-2 flex-wrap">
                  {vulnerability.cwe && (
                    <p className="text-[10px] sm:text-xs px-1.5 py-0">{vulnerability.cwe}</p>
                  )}
                  <Badge variant="outline" className="text-[10px] sm:text-xs uppercase px-1.5 py-0">
                    {vulnerability.source}
                  </Badge>
                  {issueNumber && (
                    <Badge variant="secondary" className="text-[10px] sm:text-xs px-1.5 py-0">
                      <Github className="h-2.5 w-2.5 sm:h-3 sm:w-3 mr-1" />
                      #{issueNumber}
                    </Badge>
                  )}
                </div>
              </div>
            </div>

            <div className="shrink-0 pt-0.5">
              {isExpanded ? (
                <ChevronDown className="h-4 w-4 sm:h-5 sm:w-5 text-muted-foreground" />
              ) : (
                <ChevronRight className="h-4 w-4 sm:h-5 sm:w-5 text-muted-foreground" />
              )}
            </div>
          </div>
        </CollapsibleTrigger>

        <CollapsibleContent>
          <div className="px-3 sm:px-4 pb-3 sm:pb-4 space-y-3 sm:space-y-4">
            <Separator />

            {/* Description */}
            <div>
              <h5 className="font-semibold text-xs sm:text-sm mb-1.5 sm:mb-2">Description</h5>
              <p className="text-xs sm:text-sm text-muted-foreground leading-relaxed">
                {vulnerability.description}
              </p>
            </div>

            {/* Code Snippet */}
            {vulnerability.code_snippet && (
              <div>
                <h5 className="font-semibold text-xs sm:text-sm mb-1.5 sm:mb-2">Code Snippet</h5>
                <pre className="bg-muted p-2.5 sm:p-3 rounded-lg text-[10px] sm:text-xs overflow-x-auto border max-w-full">
                  <code className="break-all whitespace-pre-wrap sm:whitespace-pre">
                    {vulnerability.code_snippet}
                  </code>
                </pre>
              </div>
            )}

            {/* Remediation */}
            {vulnerability.remediation && (
              <div>
                <h5 className="font-semibold text-xs sm:text-sm mb-1.5 sm:mb-2 flex items-center gap-2">
                  <CheckCircle2 className="h-3.5 w-3.5 sm:h-4 sm:w-4 text-green-600" />
                  Recommended Fix
                </h5>
                <p className="text-xs sm:text-sm text-muted-foreground leading-relaxed">
                  {vulnerability.remediation}
                </p>
              </div>
            )}

            {/* Action Row */}
            <div className="flex gap-2 pt-1 sm:pt-2 flex-wrap">
              <Button
                size="sm"
                variant="outline"
                asChild
                className="text-xs sm:text-sm h-8 sm:h-9 flex-1 sm:flex-none"
              >
                <Link
                  href={`/dashboard/projects/${projectId}/scans/${scanId}/vulnerabilities/${vulnerability.id}?type=${vulnerability.source}`}
                >
                  <span className="hidden xs:inline">View Full Details</span>
                  <span className="xs:hidden">Details</span>
                  <ExternalLink className="ml-1.5 sm:ml-2 h-3 w-3" />
                </Link>
              </Button>

              {loadingIssue ? (
                <Button
                  size="sm"
                  variant="outline"
                  disabled
                  className="h-8 sm:h-9 text-xs sm:text-sm"
                >
                  <Loader2 className="w-3 h-3 mr-1 animate-spin" />
                  <span className="hidden sm:inline">Loading...</span>
                </Button>
              ) : !issueUrl ? (
                <Button
                  size="sm"
                  variant="outline"
                  onClick={handleCreateIssue}
                  disabled={creatingIssue}
                  className="h-8 sm:h-9 text-xs sm:text-sm"
                >
                  {creatingIssue ? (
                    <>
                      <Loader2 className="w-3 h-3 mr-1 animate-spin" />
                      <span className="hidden sm:inline">Creating...</span>
                    </>
                  ) : (
                    <>
                      <Github className="w-3 h-3 mr-1" />
                      <span className="hidden sm:inline">Create Issue</span>
                      <span className="sm:hidden">Issue</span>
                    </>
                  )}
                </Button>
              ) : (
                <Button
                  size="sm"
                  variant="outline"
                  asChild
                  className="h-8 sm:h-9 text-xs sm:text-sm"
                >
                  <Link href={issueUrl} target="_blank" rel="noopener noreferrer">
                    <Github className="w-3 h-3 mr-1" />
                    <span className="hidden sm:inline">Issue #{issueNumber}</span>
                    <span className="sm:hidden">#{issueNumber}</span>
                    <ExternalLink className="ml-1 h-3 w-3" />
                  </Link>
                </Button>
              )}
            </div>
          </div>
        </CollapsibleContent>
      </Collapsible>
    </Card>
  );
}


// // components/report/vulnerability-card.tsx - Updated with Issue Creation 2ND VERSION
// "use client";

// import { useState } from "react";
// import { Card, CardContent } from "@/components/ui/card";
// import { Button } from "@/components/ui/button";
// import { Badge } from "@/components/ui/badge";
// import {
//   DropdownMenu,
//   DropdownMenuContent,
//   DropdownMenuItem,
//   DropdownMenuTrigger,
// } from "@/components/ui/dropdown-menu";
// import {
//   AlertCircle,
//   AlertTriangle,
//   Info,
//   MoreVertical,
//   ExternalLink,
//   FileText,
//   Loader2,
//   Github,
//   CheckCircle2,
// } from "lucide-react";
// import Link from "next/link";
// import { useToast } from "@/hooks/use-toast";

// export interface VulnerabilityData {
//   id: string;
//   severity: "critical" | "high" | "medium" | "low" | "info";
//   title: string;
//   file: string;
//   line: number | null;
//   description: string;
//   remediation?: string;
//   cwe?: string;
//   code_snippet?: string;
//   source: "sast" | "sca" | "secrets" | "iac" | "container";
//   github_issue_url?: string;
//   github_issue_number?: number;
// }

// interface VulnerabilityCardProps {
//   vulnerability: VulnerabilityData;
//   projectId: string;
//   scanId: string;
// }

// export function VulnerabilityCard({
//   vulnerability,
//   projectId,
//   scanId,
// }: VulnerabilityCardProps) {
//   const { toast } = useToast();
//   const [creatingIssue, setCreatingIssue] = useState(false);
//   const [issueUrl, setIssueUrl] = useState<string | undefined>(
//     vulnerability.github_issue_url
//   );
//   const [issueNumber, setIssueNumber] = useState<number | undefined>(
//     vulnerability.github_issue_number
//   );

//   const getSeverityConfig = (severity: string) => {
//     const configs = {
//       critical: {
//         icon: AlertCircle,
//         className: "bg-red-100 text-red-800 dark:bg-red-950 dark:text-red-400",
//         label: "Critical",
//       },
//       high: {
//         icon: AlertTriangle,
//         className: "bg-orange-100 text-orange-800 dark:bg-orange-950 dark:text-orange-400",
//         label: "High",
//       },
//       medium: {
//         icon: AlertTriangle,
//         className: "bg-yellow-100 text-yellow-800 dark:bg-yellow-950 dark:text-yellow-400",
//         label: "Medium",
//       },
//       low: {
//         icon: Info,
//         className: "bg-blue-100 text-blue-800 dark:bg-blue-950 dark:text-blue-400",
//         label: "Low",
//       },
//       info: {
//         icon: Info,
//         className: "bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-400",
//         label: "Info",
//       },
//     };
//     return configs[severity] || configs.info;
//   };

//   const handleCreateIssue = async () => {
//     try {
//       setCreatingIssue(true);

//       const response = await fetch(
//         `/api/vulnerabilities/${vulnerability.source}/${vulnerability.id}/create-issue`,
//         {
//           method: "POST",
//           headers: {
//             "Content-Type": "application/json",
//             Authorization: `Bearer ${localStorage.getItem("token")}`,
//           },
//         }
//       );

//       if (!response.ok) {
//         throw new Error("Failed to create GitHub issue");
//       }

//       const data = await response.json();

//       if (data.success) {
//         setIssueUrl(data.issue_url);
//         setIssueNumber(data.issue_number);

//         toast({
//           title: "Issue Created",
//           description: `GitHub issue #${data.issue_number} created successfully`,
//         });
//       } else {
//         throw new Error(data.error || "Failed to create issue");
//       }
//     } catch (err: any) {
//       toast({
//         title: "Failed to Create Issue",
//         description: err.message || "An error occurred",
//         variant: "destructive",
//       });
//     } finally {
//       setCreatingIssue(false);
//     }
//   };

//   const severityConfig = getSeverityConfig(vulnerability.severity);
//   const SeverityIcon = severityConfig.icon;

//   return (
//     <Card className="hover:shadow-md transition-shadow">
//       <CardContent className="pt-4 pb-4">
//         <div className="flex items-start gap-3">
//           {/* Severity Icon */}
//           <div className="mt-1 shrink-0">
//             <SeverityIcon className="h-5 w-5" />
//           </div>

//           {/* Content */}
//           <div className="flex-1 min-w-0">
//             {/* Header */}
//             <div className="flex items-start justify-between gap-2 mb-2">
//               <div className="flex-1 min-w-0">
//                 <div className="flex items-center gap-2 mb-1 flex-wrap">
//                   <Badge className={severityConfig.className}>
//                     {severityConfig.label}
//                   </Badge>
//                   <Badge variant="outline" className="uppercase text-xs">
//                     {vulnerability.source}
//                   </Badge>
//                   {vulnerability.cwe && (
//                     <Badge variant="outline" className="text-xs">
//                       {vulnerability.cwe}
//                     </Badge>
//                   )}
//                   {issueUrl && (
//                     <Badge variant="secondary" className="text-xs">
//                       <Github className="h-3 w-3 mr-1" />
//                       #{issueNumber}
//                     </Badge>
//                   )}
//                 </div>
//                 <h4 className="font-semibold text-sm mb-1 break-words">
//                   {vulnerability.title}
//                 </h4>
//                 <div className="flex items-center gap-2 text-xs text-muted-foreground">
//                   <code className="bg-muted px-1.5 py-0.5 rounded">
//                     {vulnerability.file}
//                     {vulnerability.line && `:${vulnerability.line}`}
//                   </code>
//                 </div>
//               </div>

//               {/* Actions Menu */}
//               <DropdownMenu>
//                 <DropdownMenuTrigger asChild>
//                   <Button variant="ghost" size="icon" className="h-8 w-8 shrink-0">
//                     <MoreVertical className="h-4 w-4" />
//                   </Button>
//                 </DropdownMenuTrigger>
//                 <DropdownMenuContent align="end">
//                   <DropdownMenuItem asChild>
//                     <Link
//                       href={`/dashboard/projects/${projectId}/scans/${scanId}/vulnerabilities/${vulnerability.id}?type=${vulnerability.source}`}
//                       className="cursor-pointer"
//                     >
//                       <FileText className="mr-2 h-4 w-4" />
//                       View Details
//                     </Link>
//                   </DropdownMenuItem>

//                   {issueUrl ? (
//                     <DropdownMenuItem asChild>
//                       <a
//                         href={issueUrl}
//                         target="_blank"
//                         rel="noopener noreferrer"
//                         className="cursor-pointer"
//                       >
//                         <Github className="mr-2 h-4 w-4" />
//                         View Issue #{issueNumber}
//                       </a>
//                     </DropdownMenuItem>
//                   ) : (
//                     <DropdownMenuItem
//                       onClick={handleCreateIssue}
//                       disabled={creatingIssue}
//                     >
//                       {creatingIssue ? (
//                         <>
//                           <Loader2 className="mr-2 h-4 w-4 animate-spin" />
//                           Creating...
//                         </>
//                       ) : (
//                         <>
//                           <Github className="mr-2 h-4 w-4" />
//                           Create GitHub Issue
//                         </>
//                       )}
//                     </DropdownMenuItem>
//                   )}
//                 </DropdownMenuContent>
//               </DropdownMenu>
//             </div>

//             {/* Description */}
//             <p className="text-sm text-muted-foreground mb-2 line-clamp-2">
//               {vulnerability.description}
//             </p>

//             {/* Footer */}
//             <div className="flex items-center justify-between gap-2 pt-2 border-t">
//               <div className="flex items-center gap-2">
//                 <Button variant="outline" size="sm" asChild>
//                   <Link
//                     href={`/dashboard/projects/${projectId}/scans/${scanId}/vulnerabilities/${vulnerability.id}?type=${vulnerability.source}`}
//                   >
//                     <ExternalLink className="h-3 w-3 mr-1" />
//                     Details
//                   </Link>
//                 </Button>

//                 {issueUrl && (
//                   <Button variant="outline" size="sm" asChild>
//                     <a href={issueUrl} target="_blank" rel="noopener noreferrer">
//                       <Github className="h-3 w-3 mr-1" />
//                       Issue
//                     </a>
//                   </Button>
//                 )}
//               </div>

//               {!issueUrl && (
//                 <Button
//                   size="sm"
//                   onClick={handleCreateIssue}
//                   disabled={creatingIssue}
//                 >
//                   {creatingIssue ? (
//                     <>
//                       <Loader2 className="mr-2 h-3 w-3 animate-spin" />
//                       Creating...
//                     </>
//                   ) : (
//                     <>
//                       <Github className="mr-2 h-3 w-3" />
//                       Create Issue
//                     </>
//                   )}
//                 </Button>
//               )}
//             </div>
//           </div>
//         </div>
//       </CardContent>
//     </Card>
//   );
// }





