// src/modules/vulnerability/routes.ts - FIXED: Scan-based routing
import type { FastifyInstance } from 'fastify';
import * as controller from './controller';
import { verifyAuth, loadProfile } from '../../middleware/auth';
import {
  requireAuth,
  requireProfile,
  requireOnboardingCompleted,
} from '../../middleware/gatekeepers';


export default async function vulnerabilitiesRoutes(fastify: FastifyInstance) {
  const preHandler = [
    verifyAuth,
    loadProfile,
    requireAuth,
    requireProfile,
    requireOnboardingCompleted,
  ];

  /**
   * GET /api/vulnerabilities/scan/:scanId
   * Get all vulnerabilities for a specific scan (across all types)
   */
  fastify.get('/scan/:scanId', controller.getVulnerabilitiesByScanController);

  /**
   * GET /api/vulnerabilities/scan/:scanId/:type
   * Get vulnerabilities by type for a specific scan
   */
  fastify.get(
    '/scan/:scanId/:type',
    { preHandler },
    controller.getVulnerabilitiesByScanAndTypeController
  );

  /**
   * GET /api/vulnerabilities/details/:type/:id
   * Get single vulnerability details
   */
  fastify.get(
    '/details/:type/:id',
    { preHandler },
    controller.getVulnerabilityDetailsController
  );

  /**
   * PATCH /api/vulnerabilities/details/:type/:id
   * Update vulnerability status (triage)
   */
  fastify.patch(
    '/details/:type/:id',
    { preHandler },
    controller.updateVulnerabilityStatusController
  );

  // Keep repository-level stats for dashboard
  /**
   * GET /api/vulnerabilities/repository/:repoId/stats
   * Get vulnerability statistics for entire repository (all scans)
   */
  fastify.get('/repository/:repoId/stats', { preHandler }, controller.getRepositoryStatsController);

   /**
   * POST /api/vulnerabilities/:type/:id/create-issue
   * Create GitHub issue for a specific vulnerability
   */
  fastify.post('/:type/:id/create-issue', { preHandler }, controller.createGitHubIssueController);

}